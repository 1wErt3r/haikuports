SUMMARY="A QtWebEngine browser"
DESCRIPTION="Falkon is a KDE web browser using QtWebEngine rendering engine, \
previously known as QupZilla. It aims to be a lightweight web browser available \
through all major platforms."
HOMEPAGE="https://falkon.org/"
COPYRIGHT="2009-2019 Falkon Browser Team"
LICENSE="GNU GPL v3"
REVISION="1"
SOURCE_URI="https://download.kde.org/stable/falkon/3.1/falkon-$portVersion.tar.xz"
CHECKSUM_SHA256="ce743cd80c0e2d525a784e29c9b487f73480119b0567f9ce8ef1f44cca527587"
PATCHES="falkon-$portVersion.patchset"
ADDITIONAL_FILES="
	falkon.rdef.in
	"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="?x86"

PROVIDES="
	falkon$secondaryArchSuffix = $portVersion
	app:Falkon$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libQt5Core$secondaryArchSuffix
	lib:libQt5DBus$secondaryArchSuffix
	lib:libQt5Gui$secondaryArchSuffix
	lib:libQt5Network$secondaryArchSuffix
	lib:libQt5Positioning$secondaryArchSuffix
	lib:libQt5PrintSupport$secondaryArchSuffix
	lib:libQt5Qml$secondaryArchSuffix
	lib:libQt5QmlModels$secondaryArchSuffix
	lib:libQt5Quick$secondaryArchSuffix
	lib:libQt5QuickWidgets$secondaryArchSuffix
	lib:libQt5Sql$secondaryArchSuffix
	lib:libQt5WebChannel$secondaryArchSuffix
	lib:libQt5WebEngine$secondaryArchSuffix
	lib:libQt5WebEngineCore$secondaryArchSuffix
	lib:libQt5WebEngineWidgets$secondaryArchSuffix
	lib:libQt5Widgets$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libKF5I18n$secondaryArchSuffix
	devel:libQt5Core$secondaryArchSuffix
	devel:libQt5DBus$secondaryArchSuffix
	devel:libQt5Gui$secondaryArchSuffix
	devel:libQt5Network$secondaryArchSuffix
	devel:libQt5PrintSupport$secondaryArchSuffix
	devel:libQt5Positioning$secondaryArchSuffix
	devel:libQt5Qml$secondaryArchSuffix
	devel:libQt5QmlModels$secondaryArchSuffix
	devel:libQt5Quick$secondaryArchSuffix
	devel:libQt5QuickWidgets$secondaryArchSuffix
	devel:libQt5Sql$secondaryArchSuffix
	devel:libQt5WebChannel$secondaryArchSuffix
	devel:libQt5WebEngine$secondaryArchSuffix
	devel:libQt5WebEngineCore$secondaryArchSuffix
	devel:libQt5WebEngineWidgets$secondaryArchSuffix
	devel:libQt5Widgets$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	extra_cmake_modules
	"
BUILD_PREREQUIRES="
	cmd:cmake
	cmd:g++$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	cmd:qdbuscpp2xml$secondaryArchSuffix >= 5
	cmd:sed
	"

defineDebugInfoPackage falkon$secondaryArchSuffix \
	"$appsDir"/Falkon/Falkon

BUILD()
{
	cmake -S . -B build \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DCMAKE_INSTALL_PREFIX:PATH="$appsDir/Falkon" \
		-DCMAKE_INSTALL_DATAROOTDIR:PATH="$dataDir" \
		-DKDE_INSTALL_PLUGINDIR=$addOnsDir/Qt5 \
		-DECM_MKSPECS_INSTALL_DIR=$dataDir/Qt5/mkspecs \
		-DECM_DIR=/system/data/cmake/Modules/ECM/cmake
	make -C build $jobArgs
}

INSTALL()
{
	make -C build install

	mv $appsDir/Falkon/bin/falkon \
		$appsDir/Falkon/Falkon

	rm -rf $appsDir/Otter-Browser/bin

	local APP_SIGNATURE="application/x-vnd.falkon"
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		$portDir/additional-files/falkon.rdef.in > falkon.rdef

	addResourcesToBinaries falkon.rdef \
		$appsDir/Falkon/Falkon

	addAppDeskbarSymlink $appsDir/Falkon/Falkon "Falkon"
}
